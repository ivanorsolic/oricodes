<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.62.1" />
    <meta name="description" content="Ori&#39;s self-driving RC car">
<meta name="author" content="ori">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Creating our first custom network architecture :: Ori Codes</title>

    
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/auto-complete.css" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    
      <link href="/css/theme-mine.css" rel="stylesheet">
    

    <script src="/js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" async
  src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['++','++']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });

  MathJax.Hub.Config({
  
  TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
</script>
    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/artificial-intelligence/custom-architecture/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://ori.codes/">
  <img src="/images/logo.png">
</a>

	  2605 words.<br>
	  Reading time: 13 minutes.
	  
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js"></script>
<script type="text/javascript" src="/js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/ori.codes\/";
    
</script>
<script type="text/javascript" src="/js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/rc-car/" title="RC Cars: a primer" class="dd-item 
        
        
        
        ">
      <a href="/rc-car/">
          <b>1. </b>RC Cars: a primer
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/rc-car/parts_list/" title="Parts: an overview" class="dd-item ">
        <a href="/rc-car/parts_list/">
        Parts: an overview
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/scale/" title="Scale" class="dd-item ">
        <a href="/rc-car/scale/">
        Scale
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/body_type/" title="RC Car body types" class="dd-item ">
        <a href="/rc-car/body_type/">
        Body type
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/electric_motors/" title="Electric motors" class="dd-item ">
        <a href="/rc-car/electric_motors/">
        Electric motors
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/servo/" title="Steering servo" class="dd-item ">
        <a href="/rc-car/servo/">
        Servo
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/electronic_speed_controller/" title="Electronic Speed Controller" class="dd-item ">
        <a href="/rc-car/electronic_speed_controller/">
        ESC
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/receiver/" title="Receiver" class="dd-item ">
        <a href="/rc-car/receiver/">
        Receiver
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/batteries/" title="Batteries" class="dd-item ">
        <a href="/rc-car/batteries/">
        Batteries
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/hardware/" title="Hardware" class="dd-item 
        
        
        
        ">
      <a href="/hardware/">
          <b>2. </b>Hardware
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/hardware/inventory/" title="Hardware inventory" class="dd-item ">
        <a href="/hardware/inventory/">
        Inventory: stuff you&#39;ll need
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/building-the-car/" title="Assembling the RC Car" class="dd-item ">
        <a href="/hardware/building-the-car/">
        Assembling the RC Car
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/mounting-plates/" title="Building the mounting plates for the hardware" class="dd-item ">
        <a href="/hardware/mounting-plates/">
        Mounting plates
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/jetson-nano-installation/" title="Preparing the Jetson Nano" class="dd-item ">
        <a href="/hardware/jetson-nano-installation/">
        Preparing the Jetson Nano
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/assembling-the-nano/" title="Assembling the Jetson Nano" class="dd-item ">
        <a href="/hardware/assembling-the-nano/">
        Assembling the Jetson Nano
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/connecting-the-car-to-the-nano/" title="Connecting the RC to the Nano" class="dd-item ">
        <a href="/hardware/connecting-the-car-to-the-nano/">
        Connecting the RC to the Nano
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/software/" title="Software" class="dd-item 
        
        
        
        ">
      <a href="/software/">
          <b>3. </b>Software
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/software/kernel-hacking/" title="Running the OS from an external SSD using a custom kernel" class="dd-item ">
        <a href="/software/kernel-hacking/">
        OPTIONAL: Kernel Hacking
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/donkeycar/" title="DonkeyCar" class="dd-item ">
        <a href="/software/donkeycar/">
        DonkeyCar: Explained
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/donkeycar-host/" title="DonkeyCar installation: Host PC" class="dd-item ">
        <a href="/software/donkeycar-host/">
        DonkeyCar: Host PC
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/donkeycar-simulator/" title="DonkeyCar Installation: The Simulator" class="dd-item ">
        <a href="/software/donkeycar-simulator/">
        DonkeyCar: Simulator
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/donkeycar-rc/" title="DonkeyCar installation: RC car" class="dd-item ">
        <a href="/software/donkeycar-rc/">
        DonkeyCar: RC car
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/setting-up-donkeycar-on-the-rc/" title="DonkeyCar configuration: RC car" class="dd-item ">
        <a href="/software/setting-up-donkeycar-on-the-rc/">
        DonkeyCar configuration: RC car
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/calibrating-steering-and-throttle/" title="Calibrating steering and throttle" class="dd-item ">
        <a href="/software/calibrating-steering-and-throttle/">
        Calibrating steering and throttle
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/connecting-a-bluetooth-gamepad/" title="Using a gamepad" class="dd-item ">
        <a href="/software/connecting-a-bluetooth-gamepad/">
        Using a gamepad
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/test-driving-the-rc/" title="Test drive" class="dd-item ">
        <a href="/software/test-driving-the-rc/">
        Test drive
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/sanity-check-first-autopilot/" title="First Autopilot: sanity check" class="dd-item ">
        <a href="/software/sanity-check-first-autopilot/">
        First Autopilot: sanity check
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/artificial-intelligence/" title="Artificial Intelligence" class="dd-item 
        parent
        
        
        ">
      <a href="/artificial-intelligence/">
          <b>4. </b>Artificial Intelligence
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/custom-architecture/" title="Creating our first custom network architecture" class="dd-item active">
        <a href="/artificial-intelligence/custom-architecture/">
        First custom network architecture
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/artificial-intelligence/visualization/" title="Visualization" class="dd-item 
        
        
        
        ">
      <a href="/artificial-intelligence/visualization/">
          Visualization
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/visualization/cnn-activations/" title="Visualization: CNN Activations" class="dd-item ">
        <a href="/artificial-intelligence/visualization/cnn-activations/">
        CNN Activations
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/visualization/saliency-maps/" title="Visualization: Saliency Maps" class="dd-item ">
        <a href="/artificial-intelligence/visualization/saliency-maps/">
        Saliency Maps
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/visualization/donkey-makemovie/" title="Visualization: donkey makemovie" class="dd-item ">
        <a href="/artificial-intelligence/visualization/donkey-makemovie/">
        Donkey makemovie
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/artificial-intelligence/simulator-mod/" title="Simulator modding" class="dd-item 
        
        
        
        ">
      <a href="/artificial-intelligence/simulator-mod/">
          Simulator modding
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/simulator-mod/high-resolution-images/" title="Simulator mod: High resolution images" class="dd-item ">
        <a href="/artificial-intelligence/simulator-mod/high-resolution-images/">
        High res images
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/simulator-mod/custom-rc-model/" title="Simulator mod: Custom RC model" class="dd-item ">
        <a href="/artificial-intelligence/simulator-mod/custom-rc-model/">
        Custom RC model
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/artificial-intelligence/camera-calibration/" title="Camera calibration" class="dd-item 
        
        
        
        ">
      <a href="/artificial-intelligence/camera-calibration/">
          Camera calibration
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/camera-calibration/camera-distortions/" title="Camera calibration: Explaining camera distortions" class="dd-item ">
        <a href="/artificial-intelligence/camera-calibration/camera-distortions/">
        Camera distortions
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/camera-calibration/implementing-camera-calibration/" title="Camera calibration: Implementing the calibration and undistortion" class="dd-item ">
        <a href="/artificial-intelligence/camera-calibration/implementing-camera-calibration/">
        Calibration implementation
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/camera-calibration/calibrating-the-camera/" title="Camera calibration: Calibrating the camera and undistorting images" class="dd-item ">
        <a href="/artificial-intelligence/camera-calibration/calibrating-the-camera/">
        Calibrating your camera and undistorting images
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/computer-vision-lane-finding/" title="Computer Vision: Lane Finding" class="dd-item ">
        <a href="/artificial-intelligence/computer-vision-lane-finding/">
        Computer Vision: Lane Finding
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    


    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="https://ori.codes/artificial-intelligence/custom-architecture/" selected>English</option>
                    
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
	  
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
	  
    
      <section id="shortcuts">
        <h3></h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/ivanorsolic"><i class='fab fa-github'></i> Github</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://twitter.com/ivanorsolic"><i class='fab fa-twitter'></i> Twitter</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://ivanorsolic.github.io"><i class='fas fa-tasks'></i> Other stuff</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://drive.google.com/file/d/1c4F5kfnWZnwQciP8gKyKunzDOqBJ5gDM/view?usp=sharing"><i class='fas fa-file'></i> My CV</a>
              </li>
          
        </ul>
      </section>
    
      </ul>
    </section>
    
	
    <section id="footer">
      <p align="center">Built by <a href="https://twitter.com/ivanorsolic">Ori</a> with <a href="https://github.com/matcornic/hugo-theme-learn">Learn</i></a>, <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo.</a><br>
Hosted for free at <a href="https://app.netlify.com">Netlify <i class="fas fa-heart"></i></a>
</p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Creating our first custom network architecture 
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#how-do-the-architectures-that-come-with-donkey-work">How do the architectures that come with Donkey work?</a></li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#keraspilot-base-class">KerasPilot base class</a></li>
      </ul>
    </li>
    <li><a href="#tldr-how-to-implement-your-own-architecture">TL;DR: How to implement your own architecture</a></li>
    <li><a href="#implementing-a-custom-architecture">Implementing a custom architecture</a></li>
    <li><a href="#the-cnn-architecture">The CNN Architecture</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Creating our first custom network architecture
            </h1>
          

        



<p>Where do we even begin with the AI part of the project?</p>
<p>Well, I think it'd be a good idea to get the details of plugging a custom network into Donkey out of the way first.</p>
<p>If you remember the first autopilot we trained for sanity checking purposes, you'll recall we've used an architecture that came with Donkey, whose source can be found at <code>donkeycar/parts/keras.py</code>.</p>
<p>And that's pretty cool, we've already got a fair number of architectures to play around with out of the box. But we'll want to do things our way, make some custom architectures and play around with all sorts of stuff. It's also beneficial to be able to visualize how all of the pieces of your project come together before you dive all the way down into the details of it.</p>

<div class="notices info" ><p><strong>For now, I won't get into the details of machine and deep learning.</strong> That's a whole other bullet to bite, and a science of its own. One that I'm also in the process of getting to know. If you want to understand all of the details of the following content, you'll need to have some working knowledge of ML/DL. <strong>It's also okay if you don't. You'll be able to follow along and get your feet wet</strong>, you just probably won't get some implied details and minutiae.</p>
</div>

<p>Enough philosophising, let's get to work!</p>
<h2 id="how-do-the-architectures-that-come-with-donkey-work">How do the architectures that come with Donkey work?</h2>
<p>First things first, let's see how the architectures we get out of the box with Donkey work.</p>

<div class="notices tip" ><p><strong>You don't have to, and usually probably won't, do this the way I'm doing it, which is going through the source code files and seeing what happens.</strong> You can consult the documentation or ask for help on the official project channels, but I love this approach since I believe you'll get a better sense of how something works if you look at the insides of it. I'm also used to hacking and taking things apart just to see how they work, (see <a href="https://ivanorsolic.github.io">ivanorsolic.github.io</a> for examples) and sometimes you don't have the luxury of good docs and people willing to help you, so it's useful to be able to dive into the internals of something and make sense out of it. I also just think this way is much more fun 🤓, but YMMV.</p>
</div>

<h1 id="skip-to-the-tldrtldr-how-to-implement-your-own-architecture"><a href="#tldr-how-to-implement-your-own-architecture"><strong>SKIP TO THE TL;DR</strong></a></h1>
<p>When we wanted to train our first autopilot with Donkey, we used the <code>train</code> flag to tell the <code>manage.py</code> script to train a model.</p>
<p>So if we open up the <code>manage.py</code> script and look at the main method, we can see how the script handles the <code>train</code> flag:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">if</span> args[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">train</span><span style="color:#e6db74">&#39;</span>]:
        <span style="color:#f92672">from</span> train <span style="color:#f92672">import</span> multi_train, preprocessFileList
        
        tub <span style="color:#f92672">=</span> args[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--tub</span><span style="color:#e6db74">&#39;</span>]
        model <span style="color:#f92672">=</span> args[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--model</span><span style="color:#e6db74">&#39;</span>]
        transfer <span style="color:#f92672">=</span> args[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--transfer</span><span style="color:#e6db74">&#39;</span>]
        model_type <span style="color:#f92672">=</span> args[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--type</span><span style="color:#e6db74">&#39;</span>]
        continuous <span style="color:#f92672">=</span> args[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--continuous</span><span style="color:#e6db74">&#39;</span>]
        aug <span style="color:#f92672">=</span> args[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--aug</span><span style="color:#e6db74">&#39;</span>]     

        dirs <span style="color:#f92672">=</span> preprocessFileList( args[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--file</span><span style="color:#e6db74">&#39;</span>] )
        <span style="color:#66d9ef">if</span> tub <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
            tub_paths <span style="color:#f92672">=</span> [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>expanduser(n) <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> tub<span style="color:#f92672">.</span>split(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">,</span><span style="color:#e6db74">&#39;</span>)]
            dirs<span style="color:#f92672">.</span>extend( tub_paths )

        multi_train(cfg, dirs, model, transfer, model_type, continuous, aug)
</code></pre></div><p>Most notably, it uses the <code>multi_train</code> function that it imports from the <code>train.py</code> script. Other than that, it parses the rest of the arguments it needs to call the <code>multi_train</code> function and does some preprocessing with the list of tubs we want to use.</p>
<p>So, we'll open up the <code>train.py</code> script, and find the definition of the <code>multi_train</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multi_train</span>(cfg, tub, model, transfer, model_type, continuous, aug):
    <span style="color:#75715e"># choose the right regime for the given model type</span>
    train_fn <span style="color:#f92672">=</span> train
    <span style="color:#66d9ef">if</span> model_type <span style="color:#f92672">in</span> (<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">rnn</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">3d</span><span style="color:#e6db74">&#39;</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">look_ahead</span><span style="color:#e6db74">&#39;</span>):
        train_fn <span style="color:#f92672">=</span> sequence_train

    train_fn(cfg, tub, model, transfer, model_type, continuous, aug)
</code></pre></div><p>We can see that it chooses the <code>train</code> function as the default function for training the models, but can also use the <code>sequence_train</code> function if the architecture is a sequential network. Cool!</p>
<p>Since we won't be implementing a custom sequential network, we'll take a look at the default <code>train</code> function. There's a lot going on inside the function, from managing the data and creating generators to split it into batches for training to handling different model filetypes, but we don't have to, and won't go through all the details. That's one of the reasons we're using Donkey, so we don't have to everything by ourselves.</p>
<p>Our goal is to use a custom architecture with Donkey, and we're trying to find out how Donkey uses the pre-defined architectures, so this line is very much of interest to us:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"> kl <span style="color:#f92672">=</span> get_model_by_type(train_type, cfg<span style="color:#f92672">=</span>cfg)
</code></pre></div><p>The function above is imported from <code>donkeycar/utils.py</code>, so we'll open that script up and find the definition of the <code>get_model_by_type</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_model_by_type</span>(model_type, cfg):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74"></span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    given the string model_type and the configuration settings in cfg </span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    create a Keras model and return it.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#39;&#39;&#39;</span>
    <span style="color:#f92672">from</span> donkeycar.parts.keras <span style="color:#f92672">import</span> KerasRNN_LSTM, KerasBehavioral, \
        KerasCategorical, KerasIMU, KerasLinear, Keras3D_CNN, \
        KerasLocalizer, KerasLatent
    <span style="color:#f92672">from</span> donkeycar.parts.tflite <span style="color:#f92672">import</span> TFLitePilot
 
    <span style="color:#66d9ef">if</span> model_type <span style="color:#f92672">is</span> None:
        model_type <span style="color:#f92672">=</span> cfg<span style="color:#f92672">.</span>DEFAULT_MODEL_TYPE
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">get_model_by_type</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> model Type is: {}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(model_type))

    input_shape <span style="color:#f92672">=</span> (cfg<span style="color:#f92672">.</span>IMAGE_H, cfg<span style="color:#f92672">.</span>IMAGE_W, cfg<span style="color:#f92672">.</span>IMAGE_DEPTH)
    roi_crop <span style="color:#f92672">=</span> (cfg<span style="color:#f92672">.</span>ROI_CROP_TOP, cfg<span style="color:#f92672">.</span>ROI_CROP_BOTTOM)

    <span style="color:#66d9ef">if</span> model_type <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tflite_linear</span><span style="color:#e6db74">&#34;</span>:
        kl <span style="color:#f92672">=</span> TFLitePilot()
    <span style="color:#66d9ef">elif</span> model_type <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">localizer</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">or</span> cfg<span style="color:#f92672">.</span>TRAIN_LOCALIZER:
        kl <span style="color:#f92672">=</span> KerasLocalizer(num_locations<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>NUM_LOCATIONS, input_shape<span style="color:#f92672">=</span>input_shape)
        
    <span style="color:#75715e"># And so on ...</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">unknown model type: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> model_type)

    <span style="color:#66d9ef">return</span> kl
</code></pre></div><p>This is exactly what we were looking for. We can see that the function:</p>
<ul>
<li>Takes in the name of the wanted architecture as a string 
(passed to the <code>manage.py</code> script using the <code>--type</code> flag)</li>
<li>Imports all of the architectures from <code>donkeycar/parts/keras.py</code></li>
<li>Creates a model using the appropriate architecture (based on the name)</li>
<li>Returns the created model</li>
</ul>
<p>It also defines the image shape and the region of interest crop that some models use, and sets the model type to the default type (defined in <code>myconfig.py</code>) if the type isn't explicitly passed through the type flag.</p>
<p>Okay, so now we know how the <code>manage.py</code> script gets the Keras model it then trains.</p>
<p>Let's take a look at <code>keras.py</code> to see how to define a custom architecture/model.</p>
<h3 id="keraspilot-base-class">KerasPilot base class</h3>
<p>We can see that there is a base class already prepared for us, that implements functions that all models use, such as model and weight loading, training and setting the optimizer of the model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KerasPilot</span>(object):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74"></span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    Base class for Keras models that will provide steering and throttle to guide a car.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>optimizer <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">adam</span><span style="color:#e6db74">&#34;</span>
 
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load</span>(self, model_path):
        self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>load_model(model_path)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_weights</span>(self, model_path, by_name<span style="color:#f92672">=</span>True):
        self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>load_weights(model_path, by_name<span style="color:#f92672">=</span>by_name)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shutdown</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">compile</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_optimizer</span>(self, optimizer_type, rate, decay):
        <span style="color:#66d9ef">if</span> optimizer_type <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">adam</span><span style="color:#e6db74">&#34;</span>:
            self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>optimizer <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>Adam(lr<span style="color:#f92672">=</span>rate, decay<span style="color:#f92672">=</span>decay)
        <span style="color:#66d9ef">elif</span> optimizer_type <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sgd</span><span style="color:#e6db74">&#34;</span>:
            self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>optimizer <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>SGD(lr<span style="color:#f92672">=</span>rate, decay<span style="color:#f92672">=</span>decay)
        <span style="color:#66d9ef">elif</span> optimizer_type <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">rmsprop</span><span style="color:#e6db74">&#34;</span>:
            self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>optimizer <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>RMSprop(lr<span style="color:#f92672">=</span>rate, decay<span style="color:#f92672">=</span>decay)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">unknown optimizer type: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> optimizer_type)
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(self, train_gen, val_gen, 
              saved_model_path, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, steps<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, train_split<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>,
              verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, min_delta<span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0005</span>, patience<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, use_early_stop<span style="color:#f92672">=</span>True):
        
        <span style="color:#75715e"># And so on ...</span>
</code></pre></div><p>The only three functions we need to implement ourselves in our custom class are: <strong>compile</strong> and <strong>run</strong> (and the constructor)</p>
<p>Let's look at the default architecture, the <code>KerasLinear</code> class:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KerasLinear</span>(KerasPilot):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74"></span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    The KerasLinear pilot uses one neuron to output a continous value via the </span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    Keras Dense layer with linear activation. One each for steering and throttle.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    The output is not bounded.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">def</span> __init__(self, num_outputs<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">120</span>, <span style="color:#ae81ff">160</span>, <span style="color:#ae81ff">3</span>), roi_crop<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        super(KerasLinear, self)<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
        self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> default_n_linear(num_outputs, input_shape, roi_crop)
        self<span style="color:#f92672">.</span>compile()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">compile</span>(self):
        self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>compile(optimizer<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>optimizer,
                loss<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">mse</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self, img_arr):
        img_arr <span style="color:#f92672">=</span> img_arr<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>,) <span style="color:#f92672">+</span> img_arr<span style="color:#f92672">.</span>shape)
        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>predict(img_arr)
        steering <span style="color:#f92672">=</span> outputs[<span style="color:#ae81ff">0</span>]
        throttle <span style="color:#f92672">=</span> outputs[<span style="color:#ae81ff">1</span>]
        <span style="color:#66d9ef">return</span> steering[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>], throttle[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]
</code></pre></div><p>We can see that this particular class uses the <code>roi_crop</code> variable along with the <code>input_shape</code>, that gets passed to it through the <code>utils.py</code> script.</p>
<p>The class inherits the base <code>KerasPilot</code> class, and sets the <code>self.model</code> using the <code>default_n_linear</code> function, which actually implements the architecture in Keras.</p>
<p>It also compiles itself using the default parent class optimizer (adam), and uses the mean squared error as the error function.</p>
<p>Let's look at the actual Keras implementation in the <code>default_n_linear</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">default_n_linear</span>(num_outputs, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">120</span>, <span style="color:#ae81ff">160</span>, <span style="color:#ae81ff">3</span>), roi_crop<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)):

    drop <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>
    input_shape <span style="color:#f92672">=</span> adjust_input_shape(input_shape, roi_crop)
    
    img_in <span style="color:#f92672">=</span> Input(shape<span style="color:#f92672">=</span>input_shape, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">img_in</span><span style="color:#e6db74">&#39;</span>)
    x <span style="color:#f92672">=</span> img_in
    x <span style="color:#f92672">=</span> Convolution2D(<span style="color:#ae81ff">24</span>, (<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>), strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">conv2d_1</span><span style="color:#e6db74">&#34;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(drop)(x)
    x <span style="color:#f92672">=</span> Convolution2D(<span style="color:#ae81ff">32</span>, (<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>), strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">conv2d_2</span><span style="color:#e6db74">&#34;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(drop)(x)
    x <span style="color:#f92672">=</span> Convolution2D(<span style="color:#ae81ff">64</span>, (<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>), strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">conv2d_3</span><span style="color:#e6db74">&#34;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(drop)(x)
    x <span style="color:#f92672">=</span> Convolution2D(<span style="color:#ae81ff">64</span>, (<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">3</span>), strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">conv2d_4</span><span style="color:#e6db74">&#34;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(drop)(x)
    x <span style="color:#f92672">=</span> Convolution2D(<span style="color:#ae81ff">64</span>, (<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">3</span>), strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">conv2d_5</span><span style="color:#e6db74">&#34;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(drop)(x)
    
    x <span style="color:#f92672">=</span> Flatten(name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">flattened</span><span style="color:#e6db74">&#39;</span>)(x)
    x <span style="color:#f92672">=</span> Dense(<span style="color:#ae81ff">100</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(drop)(x)
    x <span style="color:#f92672">=</span> Dense(<span style="color:#ae81ff">50</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(drop)(x)

    outputs <span style="color:#f92672">=</span> []
    
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_outputs):
        outputs<span style="color:#f92672">.</span>append(Dense(<span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">linear</span><span style="color:#e6db74">&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">n_outputs</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(i))(x))
        
    model <span style="color:#f92672">=</span> Model(inputs<span style="color:#f92672">=</span>[img_in], outputs<span style="color:#f92672">=</span>outputs)
    
    <span style="color:#66d9ef">return</span> model
</code></pre></div><p>And that's the last piece of the puzzle. It takes the number of outputs, the input shape and the region of interest via parameters, and implements a Keras model.</p>
<p>So, in summary, what are the steps for making your own architecture?</p>
<h2 id="tldr-how-to-implement-your-own-architecture">TL;DR: How to implement your own architecture</h2>
<ol>
<li>
<p>Create a new Python script (or open up the <code>keras.py</code> script and work in there)</p>
</li>
<li>
<p>Import the <code>KerasPilot</code> base model class:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> donkeycar.parts.keras <span style="color:#f92672">import</span> KerasPilot
</code></pre></div></li>
<li>
<p>Define a custom function that implements your architecture in Keras</p>
</li>
<li>
<p>Define a custom class that inherits the <code>KerasPilot</code> class, implements <code>compile</code> and <code>run</code> and initializes the model using the above mentioned function</p>
</li>
<li>
<p>Add your architecture to the <code>get_model_by_type</code> function in <code>utils.py</code></p>
</li>
<li>
<p>Use your architecture by passing the <code>model_type</code> you defined in <code>utils.py</code> as the type flag to the <code>manage.py</code> script.</p>
</li>
</ol>
<h2 id="implementing-a-custom-architecture">Implementing a custom architecture</h2>
<p>First, we have to come up with an architecture to implement.</p>
<p>We'll use Nvidia's CNN architecture from the <a href="https://images.nvidia.com/content/tegra/automotive/images/2016/solutions/pdf/end-to-end-dl-using-px.pdf"><em>End to End Learning for Self-Driving Cars</em></a> paper by <em>M. Bojarski et al.</em></p>
<p>Why this particular paper? Well, I think it's fitting since it has a nice bit of self-driving RC history behind it.</p>
<p>As Nvidia states <a href="https://devblogs.nvidia.com/deep-learning-self-driving-cars/">on their blog</a>, explaining the project behind the paper:</p>
<blockquote>
<p>The groundwork for this project was actually done over 10 years ago in a Defense Advanced Research Projects Agency (DARPA) seedling project known as <strong><a href="http://net-scale.com/doc/net-scale-dave-report.pdf">DARPA Autonomous Vehicle (DAVE)</a>, in which a sub-scale radio control (RC) car drove through a junk-filled alley way</strong>. DAVE was trained on hours of human driving in similar, but not identical, environments. The training data included video from two cameras and the steering commands sent by a human operator.</p>
</blockquote>
<p>Hey, would you look at that! Back in 2004, DARPA had a seedling project which had an RC car autonomously drive through a junk-filled alley way. It was around the time the first DARPA Grand Challenge took place, in which a full-sized car had to autonomously navigate a 240 km route in the Mojave desert.</p>
<p>No cars managed to finish the course that year, with the best competitor's car (Carnegie Mellon) traveling a mere 11.78 kilometers.</p>
<p>Here's a picture of DAVE, taken from the DARPA-IPTO <a href="http://net-scale.com/doc/net-scale-dave-report.pdf"><em>Autonomous Off-Road Vehicle Control using End-to-End learning</em></a> report.</p>
<p><img src="/images/ai/dave.png" alt="DAVE"></p>
<p>I recommend reading about the original (and subsequent) DARPA Grand Challenges, and the DAVE project. It's pretty fun to see how the history of autonomous vehicles began, and how the early researches found out about all of the challenges and their solutions on the way.</p>
<p>There's also a documentary about the DARPA Grand Challenge called <strong>The Great Robot Race</strong> by Nova. You can easily find it online.</p>
<h2 id="the-cnn-architecture">The CNN Architecture</h2>
<p>Here's a picture of the architecture, <a href="https://devblogs.nvidia.com/deep-learning-self-driving-cars/">taken from Nvidia's blog</a>:</p>
<p><img src="/images/ai/architecture.png" alt="Figure 4: CNN architecture. The network has about 27 million connections and 250 thousand parameters." style="zoom:50%;" /></p>
<p>As Nvidia says in their blog post, the architecture consists of 9 layers, including a normalization layer, 5 convolutional layers, and 3 fully connected layers.</p>
<blockquote>
<p><strong>The first layer of the network performs image normalization.</strong> The normalizer is hard-coded and is not adjusted in the learning process. Performing normalization in the network allows the normalization scheme to be altered with the network architecture, and to be accelerated via GPU processing.</p>
<p><strong>The convolutional layers are designed to perform feature extraction, and are chosen empirically through a series of experiments that vary layer configurations.</strong> We then use strided convolutions in the first three convolutional layers with a 2×2 stride and a 5×5 kernel, and a non-strided convolution with a 3×3 kernel size in the final two convolutional layers.</p>
<p><strong>We follow the five convolutional layers with three fully connected layers, leading to a final output control value which is the inverse-turning-radius.</strong> The fully connected layers are designed to function as a controller for steering, but we noted that by training the system end-to-end, it is not possible to make a clean break between which parts of the network function primarily as feature extractor, and which serve as controller.</p>
</blockquote>
<p>Pretty cool. Let's implement it in Keras!</p>
<p>I've created a new Python source file in the <code>donkeycar/parts</code> folder, named <code>nvidia.py</code>.</p>
<p>I used the <code>KerasLinear</code> class as a starting point, using its <code>adjust_input_shape</code> method to crop the image to the ROI passed to the model, since I think that's a good way to get better performance.</p>
<p>I've also made the following adjustments to the original architecture:</p>
<ul>
<li>I've omitted the normalization layer for now, which can be implemented <a href="https://keras.io/layers/normalization/">using Keras&rsquo; normalization layers</a>.</li>
<li>I've added a 25 unit fully connected layer between the 50 and 10 unit layers, and a 5 unit layer before the output layer.</li>
<li>I've added dropout regularization, with a 90% keep probability.</li>
<li>I used two separate output units for steering and throttle, using the <code>KerasLinear</code> model as a starting point.</li>
</ul>
<p>This is what the above described architecture looks like implemented in Keras:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">customArchitecture</span>(num_outputs, input_shape, roi_crop):

    input_shape <span style="color:#f92672">=</span> adjust_input_shape(input_shape, roi_crop)
    img_in <span style="color:#f92672">=</span> Input(shape<span style="color:#f92672">=</span>input_shape, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">img_in</span><span style="color:#e6db74">&#39;</span>)
    x <span style="color:#f92672">=</span> img_in
    
    <span style="color:#75715e"># Dropout rate</span>
    keep_prob <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.9</span>
    rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> keep_prob
    
    <span style="color:#75715e"># Convolutional Layer 1</span>
    x <span style="color:#f92672">=</span> Convolution2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), input_shape <span style="color:#f92672">=</span> input_shape)(x)
    x <span style="color:#f92672">=</span> Dropout(rate)(x)

    <span style="color:#75715e"># Convolutional Layer 2</span>
    x <span style="color:#f92672">=</span> Convolution2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">36</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(rate)(x)

    <span style="color:#75715e"># Convolutional Layer 3</span>
    x <span style="color:#f92672">=</span> Convolution2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">48</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(rate)(x)

    <span style="color:#75715e"># Convolutional Layer 4</span>
    x <span style="color:#f92672">=</span> Convolution2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(rate)(x)

    <span style="color:#75715e"># Convolutional Layer 5</span>
    x <span style="color:#f92672">=</span> Convolution2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    x <span style="color:#f92672">=</span> Dropout(rate)(x)

    <span style="color:#75715e"># Flatten Layers</span>
    x <span style="color:#f92672">=</span> Flatten()(x)

    <span style="color:#75715e"># Fully Connected Layer 1</span>
    x <span style="color:#f92672">=</span> Dense(<span style="color:#ae81ff">100</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)

    <span style="color:#75715e"># Fully Connected Layer 2</span>
    x <span style="color:#f92672">=</span> Dense(<span style="color:#ae81ff">50</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)

    <span style="color:#75715e"># Fully Connected Layer 3</span>
    x <span style="color:#f92672">=</span> Dense(<span style="color:#ae81ff">25</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    
    <span style="color:#75715e"># Fully Connected Layer 4</span>
    x <span style="color:#f92672">=</span> Dense(<span style="color:#ae81ff">10</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    
    <span style="color:#75715e"># Fully Connected Layer 5</span>
    x <span style="color:#f92672">=</span> Dense(<span style="color:#ae81ff">5</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">relu</span><span style="color:#e6db74">&#39;</span>)(x)
    outputs <span style="color:#f92672">=</span> []
    
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_outputs):
        <span style="color:#75715e"># Output layer</span>
        outputs<span style="color:#f92672">.</span>append(Dense(<span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">linear</span><span style="color:#e6db74">&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">n_outputs</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(i))(x))
        
    model <span style="color:#f92672">=</span> Model(inputs<span style="color:#f92672">=</span>[img_in], outputs<span style="color:#f92672">=</span>outputs)
    
    <span style="color:#66d9ef">return</span> model
</code></pre></div><p>Now we need to implement our custom class, inheriting the base <code>KerasPilot</code> class:</p>
<ul>
<li>I used the adam optimizer and the mean squared error as the error function</li>
<li>I've set the model using the above <code>customArchitecture</code> function, passing it the number of outputs, the input shape and the region of interest</li>
<li>I've copied the <code>KerasLinear</code> run method, since it already implements everything needed to run</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NvidiaModel</span>(KerasPilot):
    <span style="color:#66d9ef">def</span> __init__(self, num_outputs<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">120</span>, <span style="color:#ae81ff">160</span>, <span style="color:#ae81ff">3</span>), roi_crop<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        super(NvidiaModel, self)<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
        self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> customArchitecture(num_outputs, input_shape, roi_crop)
        self<span style="color:#f92672">.</span>compile()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">compile</span>(self):
        self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>compile(optimizer<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">adam</span><span style="color:#e6db74">&#34;</span>,
                loss<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">mse</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self, img_arr):
        img_arr <span style="color:#f92672">=</span> img_arr<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>,) <span style="color:#f92672">+</span> img_arr<span style="color:#f92672">.</span>shape)
        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>predict(img_arr)
        steering <span style="color:#f92672">=</span> outputs[<span style="color:#ae81ff">0</span>]
        throttle <span style="color:#f92672">=</span> outputs[<span style="color:#ae81ff">1</span>]
        <span style="color:#66d9ef">return</span> steering[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>], throttle[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]
</code></pre></div><p>Now we need to add our custom class to the <code>utils.py</code> script so we can use it through the <code>manage.py</code> script. I've appended the following lines to the <code>get_model_by_type</code> function, right after the rest of the pre-defined architectures:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">elif</span> model_type <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">nvidia</span><span style="color:#e6db74">&#34;</span>:
    	<span style="color:#f92672">from</span> donkeycar.parts.nvidia <span style="color:#f92672">import</span> NvidiaModel
        kl <span style="color:#f92672">=</span> NvidiaModel(input_shape<span style="color:#f92672">=</span>input_shape,roi_crop<span style="color:#f92672">=</span>roi_crop)
</code></pre></div><p>And that's it! We can now train a model using the <code>manage.py</code> script. Here's the result of training the architecture using <a href="https://drive.google.com/open?id=1A5sTSddFsf494UDtnvYQBaEPYX87_LMp">this test dataset</a> and running it in the simulator:</p>
<center><video controls src="/video/nvidia_architecture_test.mp4" autoplay muted loop width=100%></video></center>
Not bad, considering it's trained on a really small dataset. Also, it's not the best driving data around. You can see it on the sharp 90 degree turns. It first goes as near as it can to the middle line, to *take a swing* so it can enter the turn faster. If we'd trained it on a much bigger dataset, with better driving data, it'd work better. 
<p>Let's move on to the next chapter, how to train your model.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
		
        
<script src="https://utteranc.es/client.js"
        repo="ivanorsolic/oriengineering"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/artificial-intelligence/" title="Artificial Intelligence"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/artificial-intelligence/visualization/" title="Visualization" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>
    </section>
    
		
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>

    <link href="/mermaid/mermaid.css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
	
  </body>
</html>

