<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.62.1" />
    <meta name="description" content="Ori&#39;s self-driving RC car">
<meta name="author" content="ori">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Visualization: Saliency Maps :: Ori Codes</title>

    
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/auto-complete.css" rel="stylesheet">
    
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    
      <link href="/css/theme-mine.css" rel="stylesheet">
    

    <script src="/js/jquery-3.3.1.min.js"></script>
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
   "HTML-CSS": { linebreaks: { automatic: true } },
           SVG: { linebreaks: { automatic: true } }
  });
  </script>
<script type="text/javascript" async
  src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['++','++']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/artificial-intelligence/visualization/saliency-maps/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://ori.codes/">
  <img src="/images/logo.png">
</a>

	  1386 words.<br>
	  Reading time: 7 minutes.
	  
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js"></script>
<script type="text/javascript" src="/js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/ori.codes\/";
    
</script>
<script type="text/javascript" src="/js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/rc-car/" title="RC Cars: a primer" class="dd-item 
        
        
        
        ">
      <a href="/rc-car/">
          <b>1. </b>RC Cars: a primer
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/rc-car/parts_list/" title="Parts: an overview" class="dd-item ">
        <a href="/rc-car/parts_list/">
        Parts: an overview
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/scale/" title="Scale" class="dd-item ">
        <a href="/rc-car/scale/">
        Scale
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/body_type/" title="RC Car body types" class="dd-item ">
        <a href="/rc-car/body_type/">
        Body type
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/electric_motors/" title="Electric motors" class="dd-item ">
        <a href="/rc-car/electric_motors/">
        Electric motors
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/servo/" title="Steering servo" class="dd-item ">
        <a href="/rc-car/servo/">
        Servo
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/electronic_speed_controller/" title="Electronic Speed Controller" class="dd-item ">
        <a href="/rc-car/electronic_speed_controller/">
        ESC
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/receiver/" title="Receiver" class="dd-item ">
        <a href="/rc-car/receiver/">
        Receiver
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/rc-car/batteries/" title="Batteries" class="dd-item ">
        <a href="/rc-car/batteries/">
        Batteries
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/hardware/" title="Hardware" class="dd-item 
        
        
        
        ">
      <a href="/hardware/">
          <b>2. </b>Hardware
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/hardware/inventory/" title="Hardware inventory" class="dd-item ">
        <a href="/hardware/inventory/">
        Inventory: stuff you&#39;ll need
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/building-the-car/" title="Assembling the RC Car" class="dd-item ">
        <a href="/hardware/building-the-car/">
        Assembling the RC Car
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/mounting-plates/" title="Building the mounting plates for the hardware" class="dd-item ">
        <a href="/hardware/mounting-plates/">
        Mounting plates
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/jetson-nano-installation/" title="Preparing the Jetson Nano" class="dd-item ">
        <a href="/hardware/jetson-nano-installation/">
        Preparing the Jetson Nano
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/assembling-the-nano/" title="Assembling the Jetson Nano" class="dd-item ">
        <a href="/hardware/assembling-the-nano/">
        Assembling the Jetson Nano
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/hardware/connecting-the-car-to-the-nano/" title="Connecting the RC to the Nano" class="dd-item ">
        <a href="/hardware/connecting-the-car-to-the-nano/">
        Connecting the RC to the Nano
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/software/" title="Software" class="dd-item 
        
        
        
        ">
      <a href="/software/">
          <b>3. </b>Software
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/software/kernel-hacking/" title="Running the OS from an external SSD using a custom kernel" class="dd-item ">
        <a href="/software/kernel-hacking/">
        OPTIONAL: Kernel Hacking
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/donkeycar/" title="DonkeyCar" class="dd-item ">
        <a href="/software/donkeycar/">
        DonkeyCar: Explained
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/donkeycar-host/" title="DonkeyCar installation: Host PC" class="dd-item ">
        <a href="/software/donkeycar-host/">
        DonkeyCar: Host PC
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/donkeycar-simulator/" title="DonkeyCar Installation: The Simulator" class="dd-item ">
        <a href="/software/donkeycar-simulator/">
        DonkeyCar: Simulator
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/donkeycar-rc/" title="DonkeyCar installation: RC car" class="dd-item ">
        <a href="/software/donkeycar-rc/">
        DonkeyCar: RC car
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/setting-up-donkeycar-on-the-rc/" title="DonkeyCar configuration: RC car" class="dd-item ">
        <a href="/software/setting-up-donkeycar-on-the-rc/">
        DonkeyCar configuration: RC car
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/calibrating-steering-and-throttle/" title="Calibrating steering and throttle" class="dd-item ">
        <a href="/software/calibrating-steering-and-throttle/">
        Calibrating steering and throttle
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/connecting-a-bluetooth-gamepad/" title="Using a gamepad" class="dd-item ">
        <a href="/software/connecting-a-bluetooth-gamepad/">
        Using a gamepad
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/test-driving-the-rc/" title="Test drive" class="dd-item ">
        <a href="/software/test-driving-the-rc/">
        Test drive
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/software/sanity-check-first-autopilot/" title="First Autopilot: sanity check" class="dd-item ">
        <a href="/software/sanity-check-first-autopilot/">
        First Autopilot: sanity check
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/artificial-intelligence/" title="Artificial Intelligence" class="dd-item 
        parent
        
        
        ">
      <a href="/artificial-intelligence/">
          <b>4. </b>Artificial Intelligence
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/custom-architecture/" title="Creating our first custom network architecture" class="dd-item ">
        <a href="/artificial-intelligence/custom-architecture/">
        First custom network architecture
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/artificial-intelligence/visualization/" title="Visualization" class="dd-item 
        parent
        
        
        ">
      <a href="/artificial-intelligence/visualization/">
          Visualization
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/visualization/cnn-activations/" title="Visualization: CNN Activations" class="dd-item ">
        <a href="/artificial-intelligence/visualization/cnn-activations/">
        CNN Activations
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/visualization/saliency-maps/" title="Visualization: Saliency Maps" class="dd-item active">
        <a href="/artificial-intelligence/visualization/saliency-maps/">
        Saliency Maps
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/visualization/donkey-makemovie/" title="Visualization: donkey makemovie" class="dd-item ">
        <a href="/artificial-intelligence/visualization/donkey-makemovie/">
        Donkey makemovie
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/artificial-intelligence/simulator-mod/" title="Simulator modding" class="dd-item 
        
        
        
        ">
      <a href="/artificial-intelligence/simulator-mod/">
          Simulator modding
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/simulator-mod/high-resolution-images/" title="Simulator mod: High resolution images" class="dd-item ">
        <a href="/artificial-intelligence/simulator-mod/high-resolution-images/">
        High res images
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/simulator-mod/custom-rc-model/" title="Simulator mod: Custom RC model" class="dd-item ">
        <a href="/artificial-intelligence/simulator-mod/custom-rc-model/">
        Custom RC model
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/artificial-intelligence/camera-calibration/" title="Camera calibration" class="dd-item 
        
        
        
        ">
      <a href="/artificial-intelligence/camera-calibration/">
          Camera calibration
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/camera-calibration/camera-distortions/" title="Camera calibration: Explaining camera distortions" class="dd-item ">
        <a href="/artificial-intelligence/camera-calibration/camera-distortions/">
        Camera distortions
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/camera-calibration/implementing-camera-calibration/" title="Camera calibration: Implementing the calibration and undistortion" class="dd-item ">
        <a href="/artificial-intelligence/camera-calibration/implementing-camera-calibration/">
        Calibration implementation
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/camera-calibration/calibrating-the-camera/" title="Camera calibration: Calibrating the camera and undistorting images" class="dd-item ">
        <a href="/artificial-intelligence/camera-calibration/calibrating-the-camera/">
        Calibrating your camera and undistorting images
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/artificial-intelligence/computer-vision-lane-finding/" title="Computer Vision: Lane Finding" class="dd-item ">
        <a href="/artificial-intelligence/computer-vision-lane-finding/">
        Computer Vision: Lane Finding
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/draft-and-todo/" title="Drafts and #TODO&#39;s" class="dd-item 
        
        
        
        ">
      <a href="/draft-and-todo/">
          <b>5. </b>Drafts and #TODO&#39;s
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/draft-and-todo/how-to-train-your-model/" title="Master recipe: How train your model" class="dd-item ">
        <a href="/draft-and-todo/how-to-train-your-model/">
        Master recipe: How train your model
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/draft-and-todo/derivacije/" title="Raspisivanje math-a" class="dd-item ">
        <a href="/draft-and-todo/derivacije/">
        Random math stuff
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/draft-and-todo/hough-transform/" title="Raspisivanje Hough transform-a" class="dd-item ">
        <a href="/draft-and-todo/hough-transform/">
        Hough transform stuff
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/draft-and-todo/integrating-the-lane-finding/" title="Integrating the lane finding with our model" class="dd-item ">
        <a href="/draft-and-todo/integrating-the-lane-finding/">
        Integrating the lane finding
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/draft-and-todo/adding-behaviours/" title="Adding behaviours: automated lane changing" class="dd-item ">
        <a href="/draft-and-todo/adding-behaviours/">
        Behaviours: Lane Changing
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/draft-and-todo/data-augmentation/" title="Augmenting the data with neural style transfer" class="dd-item ">
        <a href="/draft-and-todo/data-augmentation/">
        Data augmentation: ML meets art!
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/draft-and-todo/object-detection-and-tracking/" title="Detecting and tracking objects on images" class="dd-item ">
        <a href="/draft-and-todo/object-detection-and-tracking/">
        Object recognition and tracking
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/draft-and-todo/reinforcement-learning/" title="Reinforcement learning: letting the car learn to drive on its own" class="dd-item ">
        <a href="/draft-and-todo/reinforcement-learning/">
        Reinforcement learning
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    


    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="https://ori.codes/artificial-intelligence/visualization/saliency-maps/" selected>English</option>
                    
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
	  
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
	  
    
      <section id="shortcuts">
        <h3></h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/ivanorsolic"><i class='fab fa-github'></i> Github</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://twitter.com/ivanorsolic"><i class='fab fa-twitter'></i> Twitter</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://ivanorsolic.github.io"><i class='fas fa-tasks'></i> Other stuff</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://drive.google.com/file/d/1c4F5kfnWZnwQciP8gKyKunzDOqBJ5gDM/view?usp=sharing"><i class='fas fa-file'></i> My CV</a>
              </li>
          
        </ul>
      </section>
    
      </ul>
    </section>
    
	
    <section id="footer">
      <p align="center">Built by <a href="https://twitter.com/ivanorsolic">Ori</a> with <a href="https://github.com/matcornic/hugo-theme-learn">Learn</i></a>, <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo.</a><br>
Hosted for free at <a href="https://app.netlify.com">Netlify <i class="fas fa-heart"></i></a>
</p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Visualization: Saliency Maps 
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#implementing-the-saliency-map-vizualization">Implementing the Saliency Map vizualization</a></li>
    <li><a href="#the-results">The results</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Visualization: Saliency Maps
            </h1>
          

        



<p>Another useful visual tool to see how your network works is a saliency map. They were proposed back in 1998 by Itti, Koch and Niebur, a group of neuroscientists working on feature extraction in images, in a paper titled <em><a href="http://www.lira.dist.unige.it/teaching/SINA_08-09/papers/itti98model.pdf">A Model of Saliency-based Visaul Attention for Rapid Scene Analysis</a></em>.</p>
<p>In the context of Deep Learning and convolutional neural networks, they were first mentioned by the Visual Geometry Group at the University of Oxford, in a paper called <em><a href="https://arxiv.org/pdf/1312.6034.pdf">Deep Inside Convolutional Networks: Visualising Image Classification Models and Saliency Maps</a></em></p>
<p>I won't go into excessive detail on how it works, but in our case, a saliency map will show us which pixels on the input image make the most impact on the output inferred by the network. We will make a heat map that shows us which visual features the car uses the most, in order to steer and throttle correctly. Hopefully, it should be the lane lines.</p>
<p>Now, just a day after I've implemented a script that generates a video with a saliency map, given a trained model and some input data, I've noticed that Tawn Kramer (of Donkey) has already implemented a saliency map visualization, which you can generate using the <code>donkey makemovie</code> command. But since I've already made my implementation, we'll walk through it.</p>
<p>As a starting point, I've used this <a href="https://github.com/ermolenkodev/keras-salient-object-visualisation/blob/fix_tf1.8/keras-salient-object-visualisation.ipynb">Jupyter Notebook</a> made by <a href="https://github.com/ermolenkodev/keras-salient-object-visualisation/blob/fix_tf1.8">ermolenkodev</a>.</p>
<p>I'll be using the Nvidia model we made earlier throughout the implementation. Feel free to use your own stuff in here.</p>
<h2 id="implementing-the-saliency-map-vizualization">Implementing the Saliency Map vizualization</h2>
<p>First off, we need to import all the Keras stuff we use in our model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> donkeycar.parts.keras <span style="color:#ff79c6">import</span> KerasPilot
<span style="color:#ff79c6">from</span> tensorflow.python.keras.layers <span style="color:#ff79c6">import</span> Input, Dense
<span style="color:#ff79c6">from</span> tensorflow.python.keras.models <span style="color:#ff79c6">import</span> Model, Sequential
<span style="color:#ff79c6">from</span> tensorflow.python.keras.layers <span style="color:#ff79c6">import</span> Convolution2D, Convolution2D, MaxPooling2D, Reshape, BatchNormalization
<span style="color:#ff79c6">from</span> tensorflow.python.keras.layers <span style="color:#ff79c6">import</span> Activation, Dropout, Flatten, Cropping2D, Lambda
</code></pre></div><p>Then we can copy the function that implements our model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># The ROI crop helper function</span>
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">adjust_input_shape</span>(input_shape, roi_crop):
    height <span style="color:#ff79c6">=</span> input_shape[<span style="color:#bd93f9">0</span>]
    new_height <span style="color:#ff79c6">=</span> height <span style="color:#ff79c6">-</span> roi_crop[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">-</span> roi_crop[<span style="color:#bd93f9">1</span>]
    <span style="color:#ff79c6">return</span> (new_height, input_shape[<span style="color:#bd93f9">1</span>], input_shape[<span style="color:#bd93f9">2</span>])

<span style="color:#6272a4"># The definition of our model</span>
<span style="color:#6272a4"># Also, be sure to name every convolutional layer you have as &#34;convx&#34; (x ∈ ℕ)</span>
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">customModel</span>(num_outputs<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>, input_shape<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">160</span>,<span style="color:#bd93f9">120</span>,<span style="color:#bd93f9">3</span>), roi_crop<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>)):

    input_shape <span style="color:#ff79c6">=</span> adjust_input_shape(input_shape, roi_crop)
    img_in <span style="color:#ff79c6">=</span> Input(shape<span style="color:#ff79c6">=</span>input_shape, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">img_in</span><span style="color:#f1fa8c">&#39;</span>)
    x <span style="color:#ff79c6">=</span> img_in
    
    <span style="color:#6272a4"># Dropout rate</span>
    keep_prob <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.5</span>
    rate <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">-</span> keep_prob
    
    <span style="color:#6272a4"># Convolutional Layer 1</span>
    x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">12</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv1</span><span style="color:#f1fa8c">&#34;</span>)(x)
    x <span style="color:#ff79c6">=</span> Dropout(rate)(x)

    <span style="color:#6272a4"># Convolutional Layer 2</span>
    x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">24</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv2</span><span style="color:#f1fa8c">&#34;</span>)(x)
    x <span style="color:#ff79c6">=</span> Dropout(rate)(x)

    <span style="color:#6272a4"># Convolutional Layer 3</span>
    x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">48</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv3</span><span style="color:#f1fa8c">&#34;</span>)(x)
    x <span style="color:#ff79c6">=</span> Dropout(rate)(x)

    <span style="color:#6272a4"># Convolutional Layer 4</span>
    x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">64</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv4</span><span style="color:#f1fa8c">&#34;</span>)(x)
    x <span style="color:#ff79c6">=</span> Dropout(rate)(x)

    <span style="color:#6272a4"># Convolutional Layer 5</span>
    x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">64</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv5</span><span style="color:#f1fa8c">&#34;</span>)(x)
    x <span style="color:#ff79c6">=</span> Dropout(rate)(x)

    <span style="color:#6272a4"># Flatten Layers</span>
    x <span style="color:#ff79c6">=</span> Flatten()(x)

    <span style="color:#6272a4"># Fully Connected Layer 1</span>
    x <span style="color:#ff79c6">=</span> Dense(<span style="color:#bd93f9">100</span>, activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>)(x)

    <span style="color:#6272a4"># Fully Connected Layer 2</span>
    x <span style="color:#ff79c6">=</span> Dense(<span style="color:#bd93f9">50</span>, activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>)(x)

    <span style="color:#6272a4"># Fully Connected Layer 3</span>
    x <span style="color:#ff79c6">=</span> Dense(<span style="color:#bd93f9">25</span>, activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>)(x)
    x <span style="color:#ff79c6">=</span> Dense(<span style="color:#bd93f9">10</span>, activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>)(x)
    x <span style="color:#ff79c6">=</span> Dense(<span style="color:#bd93f9">5</span>, activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>)(x)
    outputs <span style="color:#ff79c6">=</span> []
    
    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(num_outputs):
        outputs<span style="color:#ff79c6">.</span>append(Dense(<span style="color:#bd93f9">1</span>, activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">linear</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">n_outputs</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">str</span>(i))(x))
        
    model <span style="color:#ff79c6">=</span> Model(inputs<span style="color:#ff79c6">=</span>[img_in], outputs<span style="color:#ff79c6">=</span>outputs)
    
    <span style="color:#ff79c6">return</span> model
</code></pre></div><p>We can then initialize the model and pass the weights we previously trained to it:</p>
<pre><code>model = customModel()
# Pass the path to your trained .h5 file here
model.load_weights('nvidia.h5')
</code></pre><p>Now we can define just the convolutional layers we're interested in visualizing:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">img_in <span style="color:#ff79c6">=</span> Input(shape<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">160</span>,<span style="color:#bd93f9">120</span>,<span style="color:#bd93f9">3</span>), name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">img_in</span><span style="color:#f1fa8c">&#39;</span>)

x <span style="color:#ff79c6">=</span> img_in
x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">12</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv1</span><span style="color:#f1fa8c">&#34;</span>)(x)
x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">24</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv2</span><span style="color:#f1fa8c">&#34;</span>)(x)
x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">48</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv3</span><span style="color:#f1fa8c">&#34;</span>)(x)
x <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">64</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv4</span><span style="color:#f1fa8c">&#34;</span>)(x)
lastConvLayer <span style="color:#ff79c6">=</span> Convolution2D(filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">64</span>, kernel_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>, strides<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>), activation<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">relu</span><span style="color:#f1fa8c">&#39;</span>, name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">conv5</span><span style="color:#f1fa8c">&#34;</span>)(x)  

convolution_part <span style="color:#ff79c6">=</span> Model(inputs<span style="color:#ff79c6">=</span>[img_in], outputs<span style="color:#ff79c6">=</span>[lastConvLayer])
</code></pre></div><p>We can now set the weights of the convolutional layers we just created to the actual weights our model contains:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># If you have more than 5 layers, or less than 5 layers, edit the number here</span>
numberOfConvLayers <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>
<span style="color:#ff79c6">for</span> layer_num <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">1</span>, numberOfConvLayers):
    convolution_part<span style="color:#ff79c6">.</span>get_layer(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">conv</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">str</span>(layer_num))<span style="color:#ff79c6">.</span>set_weights(model<span style="color:#ff79c6">.</span>get_layer(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">conv</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">str</span>(layer_num))<span style="color:#ff79c6">.</span>get_weights())
</code></pre></div><p>To get the activation values from each layer, we need to define functors for them:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> tensorflow.python.keras <span style="color:#ff79c6">import</span> backend <span style="color:#ff79c6">as</span> K

inp <span style="color:#ff79c6">=</span> convolution_part<span style="color:#ff79c6">.</span>input  <span style="color:#6272a4"># input placeholder</span>
outputs <span style="color:#ff79c6">=</span> [layer<span style="color:#ff79c6">.</span>output <span style="color:#ff79c6">for</span> layer <span style="color:#ff79c6">in</span> convolution_part<span style="color:#ff79c6">.</span>layers[<span style="color:#bd93f9">1</span>:]] <span style="color:#6272a4"># all layer outputs</span>
functors <span style="color:#ff79c6">=</span> K<span style="color:#ff79c6">.</span>function([inp], outputs)
</code></pre></div><p>We'll also define some helper variables that we'll use for the strides, padding and the kernels while computing the visualization masks:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> tensorflow <span style="color:#ff79c6">as</span> tf
<span style="color:#ff79c6">import</span> numpy <span style="color:#ff79c6">as</span> np
<span style="color:#ff79c6">import</span> pdb

<span style="color:#6272a4"># 3x3 kernel with all ones</span>
kernel_3x3 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>constant(np<span style="color:#ff79c6">.</span>array([
        [[[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]]], 
        [[[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]]], 
        [[[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]]]
]), tf<span style="color:#ff79c6">.</span>float32)

<span style="color:#6272a4"># 5x5 kernel with all ones</span>
kernel_5x5 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>constant(np<span style="color:#ff79c6">.</span>array([
        [[[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]]], 
        [[[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]]], 
        [[[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]]],
        [[[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]]],
        [[[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]], [[<span style="color:#bd93f9">1</span>]]]
]), tf<span style="color:#ff79c6">.</span>float32)

<span style="color:#6272a4"># Based on the layers in your model, you should assign the kernel sizes you&#39;re using at each layer here.</span>
<span style="color:#6272a4"># E.g. I&#39;m using a 3x3 kernel in my last two layers, and a 3x3 in my first three layers</span>
layers_kernels <span style="color:#ff79c6">=</span> {<span style="color:#bd93f9">5</span>: kernel_3x3, <span style="color:#bd93f9">4</span>: kernel_3x3, <span style="color:#bd93f9">3</span>: kernel_5x5, <span style="color:#bd93f9">2</span>: kernel_5x5, <span style="color:#bd93f9">1</span>: kernel_5x5}

<span style="color:#6272a4"># Same goes here for the strides you&#39;re using in your layers</span>
layers_strides <span style="color:#ff79c6">=</span> {<span style="color:#bd93f9">5</span>: [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>], <span style="color:#bd93f9">4</span>: [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>], <span style="color:#bd93f9">3</span>: [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>], <span style="color:#bd93f9">2</span>: [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>], <span style="color:#bd93f9">1</span>: [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>]}
</code></pre></div><p>And we can finally compute the visualization masks using  <a href="https://github.com/ermolenkodev/keras-salient-object-visualisation/blob/fix_tf1.8">ermolenkodev's</a> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">compute_visualisation_mask</span>(input_image):
    activations <span style="color:#ff79c6">=</span> functors([np<span style="color:#ff79c6">.</span>array([input_image])])
    activations <span style="color:#ff79c6">=</span> [np<span style="color:#ff79c6">.</span>reshape(input_image, (<span style="color:#bd93f9">1</span>, input_image<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">0</span>], input_image<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">1</span>], input_image<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">2</span>]))] <span style="color:#ff79c6">+</span> activations
    upscaled_activation <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>ones((<span style="color:#bd93f9">53</span>, <span style="color:#bd93f9">73</span>))
    <span style="color:#ff79c6">for</span> layer <span style="color:#ff79c6">in</span> [<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>]: <span style="color:#6272a4"># Edit if you have a different # of layers </span>
        averaged_activation <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>mean(activations[layer], axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>)<span style="color:#ff79c6">.</span>squeeze(axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">*</span> upscaled_activation
        output_shape <span style="color:#ff79c6">=</span> (activations[layer <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">1</span>], activations[layer <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">2</span>])
        x <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>constant(
            np<span style="color:#ff79c6">.</span>reshape(averaged_activation, (<span style="color:#bd93f9">1</span>,averaged_activation<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">0</span>],averaged_activation<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">1</span>],<span style="color:#bd93f9">1</span>)),
            tf<span style="color:#ff79c6">.</span>float32
        )
        conv <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>conv2d_transpose(
        	x, layers_kernels[layer],
            output_shape<span style="color:#ff79c6">=</span>(<span style="color:#bd93f9">1</span>,output_shape[<span style="color:#bd93f9">0</span>],output_shape[<span style="color:#bd93f9">1</span>], <span style="color:#bd93f9">1</span>), 
            strides<span style="color:#ff79c6">=</span>layers_strides[layer], 
            padding<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">VALID</span><span style="color:#f1fa8c">&#39;</span>
        )
        <span style="color:#ff79c6">with</span> tf<span style="color:#ff79c6">.</span>Session() <span style="color:#ff79c6">as</span> session:
            result <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>run(conv)
        upscaled_activation <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>reshape(result, output_shape)
    final_visualisation_mask <span style="color:#ff79c6">=</span> upscaled_activation
    <span style="color:#ff79c6">return</span> (final_visualisation_mask <span style="color:#ff79c6">-</span> np<span style="color:#ff79c6">.</span>min(final_visualisation_mask))<span style="color:#ff79c6">/</span>(np<span style="color:#ff79c6">.</span>max(final_visualisation_mask) <span style="color:#ff79c6">-</span> np<span style="color:#ff79c6">.</span>min(final_visualisation_mask))
</code></pre></div><p>And the only thing we need to implement is the code to animate the results and save them as a video:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> cv2
<span style="color:#ff79c6">import</span> numpy <span style="color:#ff79c6">as</span> np
<span style="color:#ff79c6">import</span> matplotlib.pyplot <span style="color:#ff79c6">as</span> plt
<span style="color:#ff79c6">from</span> matplotlib <span style="color:#ff79c6">import</span> animation
<span style="color:#ff79c6">from</span> IPython.display <span style="color:#ff79c6">import</span> display, HTML

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">save_movie_mp4</span>(image_array, filename<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">output.gif</span><span style="color:#f1fa8c">&#39;</span>, fps<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span>):
    dpi <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">72.0</span>
    xpixels, ypixels <span style="color:#ff79c6">=</span> image_array[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">0</span>], image_array[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>shape[<span style="color:#bd93f9">1</span>]
    fig <span style="color:#ff79c6">=</span> plt<span style="color:#ff79c6">.</span>figure(figsize<span style="color:#ff79c6">=</span>(ypixels<span style="color:#ff79c6">/</span>dpi, xpixels<span style="color:#ff79c6">/</span>dpi), dpi<span style="color:#ff79c6">=</span>dpi)
    im <span style="color:#ff79c6">=</span> plt<span style="color:#ff79c6">.</span>figimage(image_array[<span style="color:#bd93f9">0</span>])

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">animate</span>(i):
        im<span style="color:#ff79c6">.</span>set_array(image_array[i])
        <span style="color:#ff79c6">return</span> (im,)
    
    writer <span style="color:#ff79c6">=</span> animation<span style="color:#ff79c6">.</span>PillowWriter(fps<span style="color:#ff79c6">=</span>fps)
    anim <span style="color:#ff79c6">=</span> animation<span style="color:#ff79c6">.</span>FuncAnimation(fig, animate, frames<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">len</span>(image_array))
    anim<span style="color:#ff79c6">.</span>save(filename, writer<span style="color:#ff79c6">=</span>writer)
</code></pre></div><p>We can now finally pass our model and our input data to the program and let it create the Saliency Map video for us:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> glob<span style="color:#ff79c6">,</span> re<span style="color:#ff79c6">,</span> time<span style="color:#ff79c6">,</span> datetime
<span style="color:#6272a4"># The path to your dataset</span>
pathToData <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">data/tub/</span><span style="color:#f1fa8c">&#39;</span>

<span style="color:#6272a4"># Output video name</span>
output <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">saliency.gif</span><span style="color:#f1fa8c">&#34;</span>

<span style="color:#6272a4"># Output FPS</span>
fps <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">60</span>

<span style="color:#6272a4"># Number of frames you want to use</span>
numberOfFrames <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">600</span>

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">sort_human</span>(l):
    convert <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">lambda</span> text: <span style="color:#8be9fd;font-style:italic">float</span>(text) <span style="color:#ff79c6">if</span> text<span style="color:#ff79c6">.</span>isdigit() <span style="color:#ff79c6">else</span> text
    alphanum <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">lambda</span> key: [convert(c) <span style="color:#ff79c6">for</span> c <span style="color:#ff79c6">in</span> re<span style="color:#ff79c6">.</span>split(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">([-+]?[0-9]*</span><span style="color:#f1fa8c">\</span><span style="color:#f1fa8c">.?[0-9]*)</span><span style="color:#f1fa8c">&#39;</span>, key)]
    l<span style="color:#ff79c6">.</span>sort(key<span style="color:#ff79c6">=</span>alphanum)
    <span style="color:#ff79c6">return</span> l

inputImages <span style="color:#ff79c6">=</span> []
alpha <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.004</span>
beta <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1.0</span> <span style="color:#ff79c6">-</span> alpha
counter <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
<span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">Generating </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">s of video.</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> (numberOfFrames<span style="color:#ff79c6">/</span>fps))
accumulatedTime <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
start <span style="color:#ff79c6">=</span> time<span style="color:#ff79c6">.</span>time()
<span style="color:#ff79c6">for</span> path <span style="color:#ff79c6">in</span> sort_human(glob<span style="color:#ff79c6">.</span>glob(pathToData <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">*.jpg</span><span style="color:#f1fa8c">&#39;</span>)):
    inputImage <span style="color:#ff79c6">=</span> cv2<span style="color:#ff79c6">.</span>imread(path)
    salient_mask <span style="color:#ff79c6">=</span> compute_visualisation_mask(inputImage)
    salient_mask_stacked <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>dstack((salient_mask,salient_mask))
    salient_mask_stacked <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>dstack((salient_mask_stacked,salient_mask))
    blend <span style="color:#ff79c6">=</span> cv2<span style="color:#ff79c6">.</span>addWeighted(inputImage<span style="color:#ff79c6">.</span>astype(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">float32</span><span style="color:#f1fa8c">&#39;</span>), alpha, salient_mask_stacked, beta, <span style="color:#bd93f9">0.0</span>)
    inputImages<span style="color:#ff79c6">.</span>append(blend)
    counter <span style="color:#ff79c6">+</span><span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>

    <span style="color:#ff79c6">if</span> counter <span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">=</span> numberOfFrames:
        <span style="color:#ff79c6">break</span>

    <span style="color:#ff79c6">elif</span> counter <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">100</span> <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>:
        end <span style="color:#ff79c6">=</span> time<span style="color:#ff79c6">.</span>time()
        accumulatedTime <span style="color:#ff79c6">+</span><span style="color:#ff79c6">=</span> end <span style="color:#ff79c6">-</span> start
        remainingSeconds <span style="color:#ff79c6">=</span> (accumulatedTime<span style="color:#ff79c6">/</span>counter)<span style="color:#ff79c6">*</span>(numberOfFrames<span style="color:#ff79c6">-</span>counter)
        <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">Generated </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">/</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c"> frames.</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> (counter, numberOfFrames))
        <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">Estimated time left: </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">m:</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">s.</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">divmod</span>(remainingSeconds, <span style="color:#bd93f9">60</span>))
        <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">Runtime so far: </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">m:</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">s.</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">divmod</span>(accumulatedTime, <span style="color:#bd93f9">60</span>))
        start <span style="color:#ff79c6">=</span> time<span style="color:#ff79c6">.</span>time()
</code></pre></div><p>And save the gif:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">save_movie_mp4(inputImages, output, fps)
</code></pre></div>
<section class="attachments grey">
	<label>
		<i class="fas fa-paperclip" aria-hidden="true"></i>
		You can download the above code as an ipynb here.
	</label>
	
		
	
	<div class="attachments-files">
	
		
		
			
				<li>
					<a href="/Artificial%20Intelligence/visualization/saliency%20maps.files/SaliencyMap.ipynb" >
						SaliencyMap.ipynb
					</a>
					(11 ko)
				</li>
			
		
	
	<div>
	
</section>


<h2 id="the-results">The results</h2>
<p>The output video I got using the Nvidia model we made earlier and the dataset we downloaded:</p>
<center><video controls src="/images/ai/saliency.mp4" autoplay loop width=100%></video></center>
We can see that the car indeed uses the lane lines, but it also uses the horizon as a feature a lot. That's quite interesting. We can get rid of that problem using a ROI crop or by implementing some computer vision feature extraction/engineering, which we'll do right after we make a high res version of the simulator. :)
<p>We can also see that it's far more interested in the right line, than the middle (left) one. That's because, in general, the car tends to go to the right, since we're driving around the circuit clockwise. We need to do some data augmentation to solve this issue, which we'll also do a bit later.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
		
        
<script src="https://utteranc.es/client.js"
        repo="ivanorsolic/oriengineering"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/artificial-intelligence/visualization/cnn-activations/" title="Visualization: CNN Activations"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/artificial-intelligence/visualization/donkey-makemovie/" title="Visualization: donkey makemovie" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>
    </section>
    
		
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    
    <script src="/js/modernizr.custom-3.6.0.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>

    <link href="/mermaid/mermaid.css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
	
  </body>
</html>

